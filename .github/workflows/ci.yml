name: CI Check

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2   # ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ commit ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi

      - name: Syntax check
        run: |
          python -m py_compile *.py

      # ===== ‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô =====
      - name: Get changed files
        id: changes
        run: |
          FILES=$(git diff --name-only HEAD~1 HEAD | head -n 10)
          FILES_ESCAPED=$(printf "%s\n" "$FILES" | sed 's/"/\\"/g')
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES_ESCAPED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # ===== ‡πÅ‡∏à‡πâ‡∏á Discord =====
      - name: Notify Discord (CI Result)
        if: always()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          STATUS: ${{ job.status }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          FILES: ${{ steps.changes.outputs.files }}
        run: |
          if [ "$STATUS" = "success" ]; then
            TITLE="‚úÖ CI Passed"
            COLOR=3066993
          else
            TITLE="‚ùå CI Failed"
            COLOR=15158332
          fi

          if [ -z "$FILES" ]; then
            FILES_TEXT="(no file changes detected)"
          else
            FILES_TEXT=$(echo "$FILES" | sed 's/^/- /')
          fi

          curl -X POST -H "Content-Type: application/json" \
          -d "{
            \"embeds\": [{
              \"title\": \"$TITLE\",
              \"color\": $COLOR,
              \"fields\": [
                { \"name\": \"üì¶ Repo\", \"value\": \"$REPO\", \"inline\": true },
                { \"name\": \"üë§ By\", \"value\": \"$ACTOR\", \"inline\": true },
                { \"name\": \"üìÅ Changed files\", \"value\": \"\n$FILES_TEXT\" },
                { \"name\": \"üîé CI Logs\", \"value\": \"[View Details]($RUN_URL)\" }
              ]
            }]
          }" $DISCORD_WEBHOOK
